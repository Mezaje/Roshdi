<!-- ========== /views/poems_index.ejs (نسخة محسّنة مع Banner + Components) ========== -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title><%= title %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <!-- تأكّد أن الملف اسمه styles.css -->
  <link rel="stylesheet" href="/style.css">
  <style>
    .page-hero{
      background:linear-gradient(180deg,var(--sand-100),var(--sand-200));
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    [data-theme="night"] .page-hero{
      background:linear-gradient(180deg,var(--sand-300),var(--sand-400));
      border-color:rgba(255,255,255,.08);
    }
    .page-hero .inner{display:grid;gap:14px;grid-template-columns:1fr;padding:28px 0}
    .crumbs{font-size:14px;color:var(--muted)}
    .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tools .input{min-width:220px}
    .head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:14px 0}
    .pager{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center}
    .pagebtn{min-width:40px;text-align:center;padding:8px 12px;border:1px solid rgba(0,0,0,.1);border-radius:12px;background:var(--card)}
    .pagebtn.active{font-weight:800;border-color:var(--oasis)}
    .pagebtn[aria-disabled="true"]{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
  <%- include('header'); %>

  <!-- Banner علوي -->
  <section class="page-hero">
    <div class="container inner">
      <nav class="crumbs" aria-label="مسار الصفحة">
        <a href="/">الرئيسية</a> › <span>القصائد</span>
      </nav>
      <div class="head" style="margin:0">
        <h1 class="kufi" style="margin:0">كل القصائد</h1>
        <div class="muted">المجموع: <strong><%= count %></strong></div>
      </div>

      <!-- أدوات: بحث + ترتيب + فلترة -->
      <div class="tools" role="region" aria-label="أدوات">
        <input id="search" class="input" type="search" inputmode="search" placeholder="ابحث عن قصيدة…" aria-label="بحث">
        <select id="sort" class="input" aria-label="ترتيب">
          <option value="new">الأحدث أولًا</option>
          <option value="old">الأقدم أولًا</option>
          <option value="az">عنوان: أ-ي</option>
          <option value="za">عنوان: ي-أ</option>
        </select>
        <select id="meterFilter" class="input" aria-label="بحر القصيدة">
          <option value="">كل البحور</option>
        </select>
        <select id="tagFilter" class="input" aria-label="وسم">
          <option value="">كل الوسوم</option>
        </select>
        <span class="pill">نتائج من <%= (page-1)*limit+1 %> إلى <%= Math.min(page*limit, count) %></span>
      </div>
    </div>
    <div class="palms" aria-hidden="true"></div>
  </section>

  <main class="container" style="padding-top:24px">
    <!-- شبكة القصائد -->
    <div id="poemGrid" class="grid poems" role="list">
      <% poems.forEach(p => { %>
        <article
          class="card show" role="listitem"
          data-title="<%- p.title %>"
          data-tags="<%- (p.tags||[]).join(', ') %>"
          data-meter="<%- (p.meter||'').trim() %>"
          data-date="<%= +new Date(p.createdAt) %>"
        >
          <% if (p.imageUrl) { %>
            <img src="<%= p.imageUrl %>" alt="" loading="lazy" decoding="async"
                 style="width:100%;height:auto;aspect-ratio:16/9;object-fit:cover;border-radius:12px;margin-bottom:10px">
          <% } %>
          <span class="pill"><%= p.meter || '—' %></span>
          <h3 style="margin:6px 0 8px"><%= p.title %></h3>
          <p class="excerpt"><%= p.excerpt.substring(0, 50) || '' %></p>
          <div class="meta">
            <span><%= new Date(p.createdAt).toLocaleDateString('ar-EG') %></span>
            <span class="chip"><%= (p.tags||[])[0] || 'قصيدة' %></span>
          </div>
          <div class="actions">
            <a class="btn" href="/poem/<%= p._id %>">اقرأ المزيد →</a>
            <button class="btn later" type="button"
              onclick="saveLater({id:'<%= p._id %>', type:'poem', title:`<%- p.title %>`, url:'/poem/<%= p._id %>'})">لاحقًا ★</button>
          </div>
        </article>
      <% }) %>
    </div>

    <!-- Pagination -->
    <nav class="pager mt-4" aria-label="صفحات">
      <a class="pagebtn" href="/poems?page=<%= Math.max(page-1,1) %>&limit=<%= limit %>" aria-disabled="<%= page===1 %>">السابق</a>
      <% let last=0; pages.forEach(n => { %>
        <% if (n - last > 1) { %><span class="muted">…</span><% } %>
        <a class="pagebtn <%= n===page ? 'active':'' %>" href="/poems?page=<%= n %>&limit=<%= limit %>"><%= n %></a>
        <% last=n; %>
      <% }) %>
      <a class="pagebtn" href="/poems?page=<%= Math.min(page+1,totalPages) %>&limit=<%= limit %>" aria-disabled="<%= page===totalPages %>">التالي</a>
    </nav>
  </main>

  <%- include('footer'); %>

  <script>
    // بناء لوائح البحور والوسوم تلقائيًا
    (function buildFilters(){
      const cards=[...document.querySelectorAll('#poemGrid .card')];
      const meters=[...new Set(cards.map(c=>(c.dataset.meter||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ar'));
      const tags=[...new Set(cards.flatMap(c=>(c.dataset.tags||'').split(',').map(t=>t.trim()).filter(Boolean)))].sort((a,b)=>a.localeCompare(b,'ar'));
      const mSel=document.getElementById('meterFilter'), tSel=document.getElementById('tagFilter');
      meters.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; mSel.appendChild(o); });
      tags.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; tSel.appendChild(o); });
    })();

    // بحث/ترتيب/فلترة عميل
    (function controls(){
      const grid=document.getElementById('poemGrid');
      const search=document.getElementById('search');
      const sort=document.getElementById('sort');
      const meter=document.getElementById('meterFilter');
      const tag=document.getElementById('tagFilter');

      function apply(){
        const q=(search.value||'').trim().toLowerCase();
        const m=(meter.value||'').trim();
        const tg=(tag.value||'').trim();

        const cards=[...grid.children];
        cards.forEach(c=>{
          const okQ = (c.dataset.title+' '+c.dataset.tags).toLowerCase().includes(q);
          const okM = !m || c.dataset.meter===m;
          const okT = !tg || (c.dataset.tags||'').split(',').map(x=>x.trim()).includes(tg);
          c.style.display = (okQ && okM && okT) ? '' : 'none';
        });

        // sorting on visible only
        const vis=cards.filter(el=>el.style.display!=='none');
        vis.sort((a,b)=>{
          if(sort.value==='new') return (+b.dataset.date) - (+a.dataset.date);
          if(sort.value==='old') return (+a.dataset.date) - (+b.dataset.date);
          if(sort.value==='az')  return a.dataset.title.localeCompare(b.dataset.title,'ar');
          if(sort.value==='za')  return b.dataset.title.localeCompare(a.dataset.title,'ar');
          return 0;
        });
        vis.forEach(c=>grid.appendChild(c));
      }
      if(search) search.addEventListener('input', apply);
      if(sort) sort.addEventListener('change', apply);
      if(meter) meter.addEventListener('change', apply);
      if(tag) tag.addEventListener('change', apply);
    })();

    // Read Later (مشترك)
    const LATER_KEY='roshdi_later_v1';
    function getLater(){ try{ return JSON.parse(localStorage.getItem(LATER_KEY)||'[]'); }catch{ return []; } }
    function setLater(list){ localStorage.setItem(LATER_KEY, JSON.stringify(list)); }
    function saveLater(item){
      const list=getLater();
      if(!list.some(x=>x.id===item.id && x.type===item.type)){ list.push(item); setLater(list); }
      alert('أُضيفت إلى "لقراءة لاحقًا".');
    }
  </script>
</body>
</html>
